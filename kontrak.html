<!DOCTYPE html>
<html lang="ms">
<head>
    <style>
        /* Tambahan CSS untuk Label Hirarki */
        .section-header {
            background: #1c1c1e; color: white; padding: 12px 18px;
            border-radius: 15px; margin-top: 25px; font-weight: 600;
            font-size: 14px; display: flex; align-items: center; gap: 10px;
        }
        .unit-label {
            margin: 15px 0 8px 10px; font-size: 13px; font-weight: 700;
            color: #007AFF; display: flex; align-items: center; gap: 8px;
        }
        .contract-card {
            margin-left: 10px; padding: 15px; margin-bottom: 12px;
            background: rgba(255,255,255,0.45); border-radius: 22px;
            border: 1px solid var(--glass-border);
        }
    </style>
</head>
<body>

<div class="container">
    <div id="homePage" class="page active">
        </div>

    <div id="kontrakPage" class="page">
        <div class="glass-card">
            <div class="header">
                <div class="back-btn" onclick="showPage('homePage')"><i class="fa-solid fa-chevron-left"></i> KEMBALI</div>
            </div>
            <h2 style="margin:0;">Direktori Kontrak</h2>
            <p style="font-size:12px; color:var(--text-secondary); margin-bottom:15px;">M&E Department Hierarchy</p>
            
            <div id="kontrakContainer">
                <p style="text-align:center; padding:20px;">Memuatkan struktur jabatan...</p>
            </div>
        </div>
    </div>

    </div>

<script>
const SUPABASE_URL = 'https://fppemnabevbcephyepwx.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwcGVtbmFiZXZiY2VwaHllcHd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMTE1NzEsImV4cCI6MjA4NzY4NzU3MX0.0C51CdBQv7KkpJoIAHYe6NWveBJsyXyPpHVFvd6eP48'; 

function showPage(pageId) {
    const pages = document.querySelectorAll('.page');
    pages.forEach(p => p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    if(pageId === 'kontrakPage') loadKontrakData();
}

async function loadKontrakData() {
    const container = document.getElementById('kontrakContainer');
    try {
        // Query Join: Kontrak -> Unit -> Seksyen
        const res = await fetch(`${SUPABASE_URL}/rest/v1/contract?select=*,units(unit_name,me_sections(section_name))`, {
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
        });
        const data = await res.json();

        if (!data || data.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:30px; opacity:0.6;">Tiada rekod kontrak aktif.</div>';
            return;
        }

        // Grouping logic: Seksyen -> Unit
        const grouped = {};
        data.forEach(item => {
            const sec = item.units?.me_sections?.section_name || "Seksyen Umum";
            const uni = item.units?.unit_name || "Unit Umum";
            if (!grouped[sec]) grouped[sec] = {};
            if (!grouped[sec][uni]) grouped[sec][uni] = [];
            grouped[sec][uni].push(item);
        });

        let html = '';
        for (const sec in grouped) {
            html += `<div class="section-header"><i class="fa-solid fa-sitemap"></i> ${sec.toUpperCase()}</div>`;
            for (const uni in grouped[sec]) {
                html += `<div class="unit-label"><i class="fa-solid fa-circle-dot" style="font-size:8px;"></i> ${uni}</div>`;
                grouped[sec][uni].forEach(c => {
                    html += `
                        <div class="contract-card">
                            <div style="font-size:10px; font-weight:bold; color:var(--ios-blue); margin-bottom:4px;">${c.contract_code}</div>
                            <div style="font-size:15px; font-weight:600; margin-bottom:8px; line-height:1.2;">${c.contract_name}</div>
                            <div style="display:flex; justify-content:space-between; border-top:1px solid rgba(0,0,0,0.05); padding-top:8px; font-size:12px;">
                                <span>${c.contractor}</span>
                                <strong>RM ${parseFloat(c.contract_sum).toLocaleString()}</strong>
                            </div>
                        </div>`;
                });
            }
        }
        container.innerHTML = html;
    } catch (err) {
        container.innerHTML = '<p style="color:red; text-align:center;">Ralat sambungan database.</p>';
    }
}

// [Kekalkan logik loadStaff & Attendance anda di sini]
window.onload = loadStaff;
</script>
</body>
</html>

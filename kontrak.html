<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>M&E-Connect v1.0</title>
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f2f2f7;
            --bg-gradient: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%);
            --glass-white: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.8);
            --text-primary: #1c1c1e;
            --text-secondary: #8e8e93;
            --ios-blue: #007AFF;
            --ios-red: #FF3B30;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'SF Pro Display', sans-serif; }
        body { margin: 0; background: var(--bg-color) var(--bg-gradient) fixed; display: flex; justify-content: center; height: 100dvh; overflow: hidden; }
        .container { width: 100%; max-width: 420px; height: 100dvh; display: flex; flex-direction: column; }
        .page { display: none; height: 100%; overflow-y: auto; padding: 20px; flex-direction: column; -webkit-overflow-scrolling: touch; }
        .page.active { display: flex; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* UI Components */
        .glass-card { background: var(--glass-white); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 24px; padding: 20px; margin-bottom: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.05); }
        .menu-item { background: white; border-radius: 20px; padding: 18px; display: flex; align-items: center; gap: 15px; margin-bottom: 12px; cursor: pointer; border: 1px solid rgba(0,0,0,0.05); }
        .menu-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; justify-content: center; align-items: center; color: white; }
        
        /* Contract List UI */
        .section-header { background: #1c1c1e; color: white; padding: 10px 15px; border-radius: 12px; margin-top: 20px; font-weight: 600; font-size: 13px; text-transform: uppercase; }
        .unit-label { margin: 12px 0 8px 5px; font-size: 13px; font-weight: 700; color: var(--ios-blue); }
        .contract-card { background: white; border-radius: 20px; padding: 15px; margin-bottom: 10px; border: 1px solid rgba(0,0,0,0.05); position: relative; }
        .delete-btn { position: absolute; top: 15px; right: 15px; color: var(--ios-red); opacity: 0.5; }
        
        /* Form Styling */
        label { font-size: 11px; font-weight: 600; color: var(--text-secondary); margin: 10px 0 5px; display: block; }
        input, select, textarea { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #ddd; background: rgba(255,255,255,0.8); font-size: 15px; margin-bottom: 8px; outline: none; }
        button { width: 100%; padding: 16px; background: var(--ios-blue); color: white; border: none; border-radius: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        
        /* Breakdown Cost UI */
        .breakdown-item { display: flex; justify-content: space-between; font-size: 11px; padding: 4px 0; border-bottom: 1px dashed #eee; }
        .breakdown-container { background: #f9f9f9; padding: 10px; border-radius: 12px; margin: 8px 0; }
    </style>
</head>
<body>

<div class="container">
    <div id="homePage" class="page active">
        <div style="text-align:center; margin: 20px 0 30px;">
            <h1 style="margin:0; font-size:26px; letter-spacing:-1px;">M&E-Connect</h1>
            <p style="color:var(--text-secondary); font-size:12px;">Tanpa Skema Public (Direct API)</p>
        </div>
        <div class="menu-item" onclick="showPage('kontrakPage')">
            <div class="menu-icon" style="background:#34C759;"><i class="fa-solid fa-folder-tree"></i></div>
            <div><h4 style="margin:0">Direktori Kontrak</h4><p style="margin:0; font-size:11px; color:var(--text-secondary)">Pecahan Seksyen & Unit</p></div>
        </div>
        <div class="menu-item" onclick="showPage('adminPage')">
            <div class="menu-icon" style="background:#007AFF;"><i class="fa-solid fa-plus"></i></div>
            <div><h4 style="margin:0">Pendaftaran</h4><p style="margin:0; font-size:11px; color:var(--text-secondary)">Tambah Unit & Kontrak</p></div>
        </div>
    </div>

    <div id="kontrakPage" class="page">
        <div class="glass-card">
            <div onclick="showPage('homePage')" style="color:var(--ios-blue); cursor:pointer; font-weight:600; margin-bottom:15px;"><i class="fa-solid fa-arrow-left"></i> KEMBALI</div>
            <h2 style="margin:0 0 15px 0;">Senarai Kontrak</h2>
            <input type="text" placeholder="Cari kontrak/vendor..." onkeyup="searchData(this.value)">
            <div id="kontrakList"></div>
        </div>
    </div>

    <div id="adminPage" class="page">
        <div class="glass-card">
            <div onclick="showPage('homePage')" style="color:var(--ios-blue); cursor:pointer; font-weight:600; margin-bottom:15px;"><i class="fa-solid fa-arrow-left"></i> KEMBALI</div>
            
            <div style="background:rgba(0,0,0,0.03); padding:15px; border-radius:15px; margin-bottom:20px;">
                <h4 style="margin-top:0">Daftar Unit</h4>
                <label>Seksyen</label>
                <select id="reg_sec_id">
                    <option value="1">Seksyen Selenggara</option>
                    <option value="2">Seksyen Pematuhan Peraturan</option>
                    <option value="3">Seksyen Pengurusan Aset & Kewangan</option>
                    <option value="4">Seksyen Projek & Perkhidmatan Teknikal</option>
                </select>
                <input type="text" id="reg_unit_name" placeholder="Nama Unit (Cth: Instrumentasi)">
                <button onclick="saveUnit()" style="padding:10px; font-size:13px; background:#5856D6;">Simpan Unit</button>
            </div>

            <form id="contractForm">
                <h4>Daftar Kontrak Baru</h4>
                <label>Unit</label>
                <select id="reg_unit_id" required><option value="">Pilih Unit</option></select>
                <label>Kod & Nama</label>
                <input type="text" id="c_code" placeholder="Kod Kontrak" required>
                <textarea id="c_name" placeholder="Tajuk Kontrak" required></textarea>
                <input type="text" id="c_vendor" placeholder="Kontraktor" required>
                
                <div style="display:flex; gap:10px;">
                    <div style="flex:1"><label>Mula</label><input type="date" id="c_start" required></div>
                    <div style="flex:1"><label>Tamat</label><input type="date" id="c_end" required></div>
                </div>

                <label>Pecahan Kos (Seksyen A/B/C)</label>
                <div id="breakdown_inputs">
                    <div class="sec-input-row" style="display:flex; gap:5px; margin-bottom:5px;">
                        <input type="text" placeholder="Nama Seksyen" class="b_name" style="flex:2">
                        <input type="number" placeholder="RM" class="b_val" oninput="sumTotal()" style="flex:1">
                    </div>
                </div>
                <button type="button" onclick="addBreakdownRow()" style="background:none; color:var(--ios-blue); border:1px dashed var(--ios-blue); font-size:12px; padding:8px; margin-top:0;">+ Tambah Pecahan</button>

                <label>Jumlah Keseluruhan (Auto)</label>
                <input type="number" id="c_sum" readonly style="background:#eee; font-weight:700;" placeholder="0.00">

                <button type="submit" id="submitBtn">Daftar Kontrak</button>
            </form>
        </div>
    </div>
</div>

<script>
    const SB_URL = 'https://fppemnabevbcephyepwx.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwcGVtbmFiZXZiY2VwaHllcHd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMTE1NzEsImV4cCI6MjA4NzY4NzU3MX0.0C51CdBQv7KkpJoIAHYe6NWveBJsyXyPpHVFvd6eP48';

    const headers = { 'apikey': SB_KEY, 'Authorization': `Bearer ${SB_KEY}`, 'Content-Type': 'application/json' };

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'kontrakPage') loadContracts();
        if(id === 'adminPage') loadUnitsDropdown();
    }

    // --- LOGIK PECAHAN KOS ---
    function addBreakdownRow() {
        const div = document.createElement('div');
        div.className = "sec-input-row";
        div.style = "display:flex; gap:5px; margin-bottom:5px;";
        div.innerHTML = `<input type="text" placeholder="Nama Seksyen" class="b_name" style="flex:2"><input type="number" placeholder="RM" class="b_val" oninput="sumTotal()" style="flex:1">`;
        document.getElementById('breakdown_inputs').appendChild(div);
    }

    function sumTotal() {
        let total = 0;
        document.querySelectorAll('.b_val').forEach(v => total += parseFloat(v.value) || 0);
        document.getElementById('c_sum').value = total.toFixed(2);
    }

    // --- DATA ACTIONS ---
    async function loadUnitsDropdown() {
    const sel = document.getElementById('reg_unit_id');
    sel.innerHTML = '<option value="">Memuatkan...</option>';
    
    try {
        const res = await fetch(`${SB_URL}/rest/v1/units?select=*&order=unit_name`, { headers });
        const data = await res.json();
        
        if (!res.ok) throw new Error(data.message || "Gagal tarik data");

        sel.innerHTML = '<option value="">Pilih Unit</option>';
        if (data.length === 0) {
            sel.innerHTML = '<option value="">(Tiada Unit Ditemui)</option>';
        } else {
            data.forEach(u => {
                sel.innerHTML += `<option value="${u.id}">${u.unit_name}</option>`;
            });
        }
    } catch (e) {
        console.error("Ralat Unit:", e);
        sel.innerHTML = '<option value="">Ralat API!</option>';
    }
}

    async function saveUnit() {
        const name = document.getElementById('reg_unit_name').value;
        const secId = document.getElementById('reg_sec_id').value;
        if(!name) return alert("Isi nama unit!");
        await fetch(`${SB_URL}/rest/v1/units`, {
            method: 'POST', headers,
            body: JSON.stringify({ section_id: secId, unit_name: name })
        });
        alert("Unit Disimpan!");
        document.getElementById('reg_unit_name').value = '';
        loadUnitsDropdown();
    }

    document.getElementById('contractForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;

        let breakdown = {};
        const names = document.querySelectorAll('.b_name');
        const vals = document.querySelectorAll('.b_val');
        names.forEach((n, i) => { if(n.value) breakdown[n.value] = parseFloat(vals[i].value) || 0; });

        const payload = {
            contract_code: document.getElementById('c_code').value,
            unit_id: parseInt(document.getElementById('reg_unit_id').value),
            contract_name: document.getElementById('c_name').value,
            contractor: document.getElementById('c_vendor').value,
            contract_sum: parseFloat(document.getElementById('c_sum').value),
            contract_start: document.getElementById('c_start').value,
            contract_end: document.getElementById('c_end').value,
            contract_sections_breakdown: breakdown
        };

        const res = await fetch(`${SB_URL}/rest/v1/contract`, {
            method: 'POST', headers, body: JSON.stringify(payload)
        });

        if(res.ok) {
            alert("Kontrak Berjaya!");
            document.getElementById('contractForm').reset();
            showPage('homePage');
        } else {
            const err = await res.json();
            alert("Ralat: " + err.message);
        }
        btn.disabled = false;
    };

    async function loadContracts() {
        const container = document.getElementById('kontrakList');
        container.innerHTML = "Memuatkan...";
        const res = await fetch(`${SB_URL}/rest/v1/contract?select=*,units(unit_name,me_sections(section_name))`, { headers });
        const data = await res.json();

        const grouped = {};
        data.forEach(c => {
            const sName = c.units?.me_sections?.section_name || "Lain-lain";
            const uName = c.units?.unit_name || "Umum";
            if(!grouped[sName]) grouped[sName] = {};
            if(!grouped[sName][uName]) grouped[sName][uName] = [];
            grouped[sName][uName].push(c);
        });

        let html = '';
        for (const sec in grouped) {
            html += `<div class="section-header">${sec}</div>`;
            for (const unit in grouped[sec]) {
                html += `<div class="unit-label"><i class="fa-solid fa-caret-right"></i> ${unit}</div>`;
                grouped[sec][unit].forEach(c => {
                    let bHtml = '';
                    if(c.contract_sections_breakdown) {
                        bHtml = '<div class="breakdown-container">';
                        for(const [k,v] of Object.entries(c.contract_sections_breakdown)) {
                            bHtml += `<div class="breakdown-item"><span>${k}</span><b>RM ${v.toLocaleString()}</b></div>`;
                        }
                        bHtml += '</div>';
                    }

                    html += `
                    <div class="contract-card">
                        <div class="delete-btn" onclick="deleteContract('${c.contract_code}')"><i class="fa-solid fa-trash"></i></div>
                        <div style="font-size:10px; color:var(--ios-blue); font-weight:700;">${c.contract_code}</div>
                        <div style="font-weight:600; margin:5px 0;">${c.contract_name}</div>
                        <div style="font-size:11px; color:var(--text-secondary);"><i class="fa-solid fa-calendar"></i> ${c.contract_start} hingga ${c.contract_end}</div>
                        ${bHtml}
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px; padding-top:10px; border-top:1px solid #eee;">
                            <span style="font-size:12px;">${c.contractor}</span>
                            <span style="font-weight:700;">RM ${parseFloat(c.contract_sum).toLocaleString()}</span>
                        </div>
                    </div>`;
                });
            }
        }
        container.innerHTML = html || "Tiada data.";
    }

    async function deleteContract(code) {
        if(!confirm("Padam kontrak ini?")) return;
        await fetch(`${SB_URL}/rest/v1/contract?contract_code=eq.${code}`, { method: 'DELETE', headers });
        loadContracts();
    }

    function searchData(q) {
        const query = q.toLowerCase();
        document.querySelectorAll('.contract-card').forEach(card => {
            card.style.display = card.innerText.toLowerCase().includes(query) ? 'block' : 'none';
        });
    }
</script>
</body>
</html>

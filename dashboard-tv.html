<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV DISPLAY - STATUS M&E</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f172a;
            --card-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --neon-green: #22c55e;
            --neon-blue: #3b82f6;
            --neon-red: #ef4444;
        }

        body {
            background: #0f172a linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            font-family: 'SF Pro Display', sans-serif, Arial;
            margin: 0; padding: 30px;
            color: white;
            height: 100vh;
            overflow: hidden; /* Lock skrin TV */
        }

        .tv-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* HEADER TV - LEBIH BESAR & JELAS */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            padding: 25px 50px;
            border-radius: 25px;
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .header-title h1 { margin: 0; font-size: 38px; letter-spacing: 2px; color: #f8fafc; }
        .header-title p { margin: 5px 0 0 0; font-size: 20px; color: var(--neon-blue); font-weight: bold; }

        .header-clock { text-align: right; }
        #liveClock { font-size: 50px; font-weight: bold; font-variant-numeric: tabular-nums; }
        #todayDate { font-size: 18px; opacity: 0.7; text-transform: uppercase; }

        /* GRID SYSTEM: 3 KOLUM UNTUK TV */
        #mainList {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            overflow-y: auto;
            padding-bottom: 50px;
        }

        .staf-card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--glass-border);
            transition: transform 0.3s ease;
        }

        .staf-info { flex: 1; }
        .staf-nama { font-size: 22px; font-weight: bold; color: #ffffff; margin-bottom: 5px; }
        .staf-jawatan { font-size: 14px; color: #94a3b8; text-transform: uppercase; }

        .badge {
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 800;
            text-align: center;
            min-width: 130px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }

        .status-hadir { background: var(--neon-green); color: #052e16; }
        .status-kerja { background: var(--neon-blue); color: #eff6ff; }
        .status-cuti { background: var(--neon-red); color: #fef2f2; }

        /* Scrollbar styling */
        #mainList::-webkit-scrollbar { width: 8px; }
        #mainList::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 10px; }
    </style>
</head>
<body>

<div class="tv-container">
    <div class="header">
        <div class="header-title">
            <h1>SISTEM STATUS KAKITANGAN M&E</h1>
            <p id="todayDate"></p>
        </div>
        <div class="header-clock">
            <div id="liveClock">00:00:00</div>
            <div style="color: var(--neon-green); font-size: 14px; font-weight: bold;">
                <i class="fa-solid fa-sync fa-spin"></i> LIVE UPDATING
            </div>
        </div>
    </div>

    <div id="mainList">
        </div>
</div>

<script>
    const S_URL = 'https://fppemnabevbcephyepwx.supabase.co'; 
    const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwcGVtbmFiZXZiY2VwaHllcHd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMTE1NzEsImV4cCI6MjA4NzY4NzU3MX0.0C51CdBQv7KkpJoIAHYe6NWveBJsyXyPpHVFvd6eP48'; 

    async function fetchAllStatus() {
        const list = document.getElementById('mainList');
        const hierarki = { 'KETUA JABATAN': 1, 'KETUA SEKSYEN': 2, 'EKSEKUTIF KANAN': 3, 'EKSEKUTIF': 4, 'PENYELIA PENTADBIRAN': 5, 'PEMBANTU PENTADBIRAN': 6, 'JURUTEKNIK': 7, 'KERANI': 8 };

        try {
            const resS = await fetch(S_URL + '/rest/v1/staff?select=*', { headers: { 'apikey': S_KEY, 'Authorization': 'Bearer ' + S_KEY } });
            let allStaff = await resS.json();

            const resA = await fetch(S_URL + '/rest/v1/attendance?select=*', { headers: { 'apikey': S_KEY, 'Authorization': 'Bearer ' + S_KEY } });
            const allAtt = await resA.json();

            const sekarang = new Date();
            const hariIni = new Date(sekarang.getFullYear(), sekarang.getMonth(), sekarang.getDate());

            allStaff.sort((a, b) => (hierarki[a.jawatan.toUpperCase().trim()] || 99) - (hierarki[b.jawatan.toUpperCase().trim()] || 99) || a.nama.localeCompare(b.nama));

            list.innerHTML = "";
            allStaff.forEach(staf => {
                const sNama = (staf.nama || "").toUpperCase().trim();
                const record = allAtt.find(a => {
                    const tMulaParts = a.tarikh_mula.split('-');
                    const tAkhirParts = a.tarikh_akhir.split('-');
                    const tMula = new Date(tMulaParts[0], tMulaParts[1] - 1, tMulaParts[2]);
                    const tAkhir = new Date(tAkhirParts[0], tAkhirParts[1] - 1, tAkhirParts[2]);
                    return a.nama.toUpperCase().trim() === sNama && hariIni >= tMula && hariIni <= tAkhir;
                });
                
                let sText = "HADIR", sClass = "status-hadir", sSub = (staf.jawatan || "").toUpperCase();
                if (record) {
                    sText = record.sebab.toUpperCase();
                    sClass = (sText.includes("CUTI") || sText.includes("SAKIT") || sText.includes("HALFDAY")) ? "status-cuti" : "status-kerja";
                    sSub = `SEHINGGA: ${record.tarikh_akhir}`;
                }

                list.innerHTML += `
                    <div class="staf-card">
                        <div class="staf-info">
                            <div class="staf-nama">${sNama}</div>
                            <div class="staf-jawatan">${staf.jawatan.toUpperCase()}</div>
                            <div style="font-size:11px; color:var(--neon-blue); margin-top:5px;">${record ? sSub : ''}</div>
                        </div>
                        <div class="badge ${sClass}">${sText}</div>
                    </div>`;
            });
        } catch (err) { console.error(err); }
    }

    function updateClock() {
        const now = new Date();
        document.getElementById('liveClock').innerText = now.toLocaleTimeString('ms-MY', { hour12: false });
        
        // Auto refresh data setiap 5 minit untuk elak beban server tapi tetap up-to-date
        if (now.getSeconds() === 0 && now.getMinutes() % 5 === 0) fetchAllStatus();
    }

    const opsi = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
    document.getElementById('todayDate').innerText = new Date().toLocaleDateString('ms-MY', opsi);
    
    // Jalankan segera
    fetchAllStatus();
    setInterval(updateClock, 1000);
    // Refresh data setiap 2 minit
    setInterval(fetchAllStatus, 120000);
</script>
</body>
</html>

<script>
    const S_URL = 'https://fppemnabevbcephyepwx.supabase.co'; 
    const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZwcGVtbmFiZXZiY2VwaHllcHd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMTE1NzEsImV4cCI6MjA4NzY4NzU3MX0.0C51CdBQv7KkpJoIAHYe6NWveBJsyXyPpHVFvd6eP48'; 

    const HIERARKI = {
        'KETUA JABATAN': 1, 'KETUA SEKSYEN': 2, 'EKSEKUTIF KANAN': 3, 'EKSEKUTIF': 4,
        'PENYELIA PENTADBIRAN': 5, 'PEMBANTU PENTADBIRAN': 6, 'JURUTEKNIK': 7, 'KERANI': 8
    };

    async function updateUI() {
        const list = document.getElementById('mainList');
        try {
            const [rS, rA] = await Promise.all([
                fetch(`${S_URL}/rest/v1/staff?select=*`, { headers: { 'apikey': S_KEY, 'Authorization': `Bearer ${S_KEY}` } }),
                fetch(`${S_URL}/rest/v1/attendance?select=*`, { headers: { 'apikey': S_KEY, 'Authorization': `Bearer ${S_KEY}` } })
            ]);

            const staff = await rS.json();
            const att = await rA.json();
            
            // LOGIK TARIKH YANG SAMA DENGAN DASHBOARD.HTML
            const sekarang = new Date();
            const hariIni = new Date(sekarang.getFullYear(), sekarang.getMonth(), sekarang.getDate());

            staff.sort((a, b) => {
                const rA = HIERARKI[a.jawatan?.toUpperCase().trim()] || 99;
                const rB = HIERARKI[b.jawatan?.toUpperCase().trim()] || 99;
                return rA - rB || a.nama.localeCompare(b.nama);
            });

            list.innerHTML = "";
            let counts = { hadir: 0, kerja: 0, cuti: 0 };

            staff.forEach((s, index) => {
                const sNama = (s.nama || "TIADA NAMA").toUpperCase().trim();
                const sJawatan = (s.jawatan || "STAF").toUpperCase().trim();
                
                // CARI REKOD DENGAN LOGIK SPLIT TARIKH (LEBIH TEPAT)
                const record = att.find(a => {
                    const namaAtt = (a.nama || "").toUpperCase().trim();
                    const tMulaParts = a.tarikh_mula.split('-');
                    const tAkhirParts = a.tarikh_akhir.split('-');
                    const tMula = new Date(tMulaParts[0], tMulaParts[1] - 1, tMulaParts[2]);
                    const tAkhir = new Date(tAkhirParts[0], tAkhirParts[1] - 1, tAkhirParts[2]);
                    return namaAtt === sNama && hariIni >= tMula && hariIni <= tAkhir;
                });
                
                let txt = "HADIR", cls = "hadir";
                if (record) {
                    txt = record.sebab.toUpperCase().trim();
                    // Warna merah untuk cuti/sakit, biru untuk mesyuarat/kerja luar
                    cls = (txt.includes("CUTI") || txt.includes("SAKIT") || txt.includes("HALFDAY")) ? "cuti" : "kerja";
                }
                counts[cls]++;

                const card = document.createElement('div');
                card.className = `staf-card c-${cls}`;
                card.style.animationDelay = `${0.3 + (index * 0.03)}s`;
                card.innerHTML = `
                    <div class="staf-info">
                        <div class="staf-nama" title="${sNama}">${sNama}</div>
                        <div class="staf-jawatan">${sJawatan}</div>
                    </div>
                    <div class="badge b-${cls}">${txt}</div>
                `;
                list.appendChild(card);
            });

            document.getElementById('countHadir').innerText = counts.hadir;
            document.getElementById('countKerja').innerText = counts.kerja;
            document.getElementById('countCuti').innerText = counts.cuti;
        } catch (e) { console.error("Sync Error:", e); }
    }

    function clock() {
        const n = new Date();
        document.getElementById('liveClock').innerText = n.toLocaleTimeString('en-GB', {hour: '2-digit', minute:'2-digit'});
        document.getElementById('todayDate').innerText = n.toLocaleDateString('ms-MY', { weekday:'long', day:'numeric', month:'long' }).toUpperCase();
    }

    setInterval(updateUI, 60000); 
    setInterval(clock, 1000); 
    updateUI(); clock();
</script>
